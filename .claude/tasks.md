# Nostalgic Counter - 実装タスク

## 🚨 優先度：高（設計変更対応）

### 1. 公開ID方式への移行 ✅ 完了
- [x] API を公開ID方式に変更
  - [x] `/api/count` を URL+トークン → 公開ID返却に変更
  - [x] `/api/display` を 公開IDベースに変更
  - [x] `/api/owner` の管理APIを実装

### 2. Redis Cloud統合 ✅ 完了
- [x] CounterDB クラスをRedis対応に改修
  - [x] メモリベースから Redis ベースに変更
  - [x] アトミックなカウントアップ実装（kv.incr）
  - [x] 日別カウントの Redis 保存機能
- [x] 環境変数の設定（デプロイ時に設定）
  - `REDIS_URL`

### 3. 公開ID生成機能 ✅ 完了
- [x] 公開ID生成ロジック実装
  - [x] ドメイン-ハッシュ8桁形式（例：blog-a7b9c3d4）
  - [x] 重複チェック機能
- [x] オーナートークンのハッシュ化保存
  - [x] SHA256でトークンをハッシュ化してRedisに保存

### 4. Web Components更新 ✅ 完了
- [x] nostalgic-counter をIDベースに変更
  - [x] url+token から id 属性に変更
  - [x] 同一ID重複カウント防止機能
- [x] 配布用JSファイルの作成
  - [x] `/public/components/display.js` として配置

### 5. 重複防止機能の改善 ✅ 完了
- [x] Redisベースの重複チェック実装
  - [x] IP+UserAgent+日付をキーにしたTTL設定
  - [x] メモリキャッシュからRedisキャッシュに移行

### 6. コードクリーンアップ ✅ 完了
- [x] 古い管理者認証コードを削除
- [x] 古い `/api/admin` エンドポイントを削除
- [x] 不要な関数（`generateCounterKey`, `isValidAdminToken`）を削除

## 📋 優先度：中

### 7. 埋め込み用スクリプトの提供 ✅ 完了
- [x] カウント用JavaScriptの配布（/components/display.js）
- [x] 簡単な設置ガイドの作成（README、docs/API.md）

### 8. パフォーマンス改善 ✅ 部分完了
- [x] 重複訪問チェックの最適化
  - [x] メモリキャッシュから Redis へ移行完了
  - [x] 24時間TTLによる自動クリーンアップ実装

### 6. 画像生成の拡張
- [ ] WebP形式の実装（現在はSVGのみ）
- [ ] カスタムスタイルの追加
- [ ] アニメーション効果のオプション

## 💡 優先度：低

### 7. 統計機能の拡充
- [ ] 時間帯別アクセス統計
- [ ] リファラー統計
- [ ] グラフ表示機能

### 8. ドキュメント整備 ✅ 完了
- [x] API仕様書の作成（docs/API.md）
- [x] 設置ガイドの充実（README.md、TypeScript対応含む）
- [x] サンプルコードの追加

### 9. テストの追加
- [ ] ユニットテスト
- [ ] E2Eテスト
- [ ] 負荷テスト

## 📝 メモ

### 設計方針
- ユーザー登録不要でシンプルに保つ
- URLごとに自動的にカウンター作成
- 管理者のみリセット・値設定が可能
- すべて無料枠で運用可能な設計

### 技術的な注意点
- Vercel の無料枠制限を考慮
- Redis Cloud の無料枠を活用
- 24時間重複防止によるデータ効率化

### 現在の未実装機能
- WebP画像形式の対応
- カスタムスタイルの追加
- アニメーション効果
- 統計機能の拡充（時間帯別、リファラーなど）
- テストコードの整備