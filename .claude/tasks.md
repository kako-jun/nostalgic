# Nostalgic Counter - 実装タスク

## 🚨 優先度：高（設計変更対応）

### 1. 公開ID方式への移行 ✅ 完了
- [x] API を公開ID方式に変更
  - [x] `/api/count` を URL+トークン → 公開ID返却に変更
  - [x] `/api/counter` を 公開IDベースに変更
  - [x] `/api/owner` の管理APIを実装

### 2. Vercel KV統合 ✅ 完了
- [x] CounterDB クラスをVercel KV対応に改修
  - [x] メモリベースから KV ベースに変更
  - [x] アトミックなカウントアップ実装（kv.incr）
  - [x] 日別カウントの KV 保存機能
- [ ] 環境変数の設定（デプロイ時に設定）
  - `KV_URL`, `KV_REST_API_URL`, `KV_REST_API_TOKEN`

### 3. 公開ID生成機能 ✅ 完了
- [x] 公開ID生成ロジック実装
  - [x] ドメイン-年-ハッシュ形式（例：blog-2025-a7b9）
  - [x] 重複チェック機能
- [x] オーナートークンのハッシュ化保存
  - [x] SHA256でトークンをハッシュ化してKVに保存

### 4. Web Components更新 ✅ 完了
- [x] nostalgic-counter をIDベースに変更
  - [x] url+token から id 属性に変更
  - [x] 同一ID重複カウント防止機能
- [x] 配布用JSファイルの作成
  - [x] `/public/components/counter.js` として配置

### 5. 重複防止機能の改善 ✅ 完了
- [x] KVベースの重複チェック実装
  - [x] IP+UserAgent+日付をキーにしたTTL設定
  - [x] メモリキャッシュからKVキャッシュに移行

### 6. コードクリーンアップ ✅ 完了
- [x] 古い管理者認証コードを削除
- [x] 古い `/api/admin` エンドポイントを削除
- [x] 不要な関数（`generateCounterKey`, `isValidAdminToken`）を削除

## 📋 優先度：中

### 4. 埋め込み用スクリプトの提供
- [ ] カウント用JavaScriptの配布方法検討
  - CDN経由での提供
  - npm パッケージ化
- [ ] 簡単な設置ガイドの作成

### 5. パフォーマンス改善
- [ ] 重複訪問チェックの最適化
  - 現在のメモリキャッシュから Redis/Vercel KV へ
  - より効率的なクリーンアップ処理

### 6. 画像生成の拡張
- [ ] WebP形式の実装（現在はSVGのみ）
- [ ] カスタムスタイルの追加
- [ ] アニメーション効果のオプション

## 💡 優先度：低

### 7. 統計機能の拡充
- [ ] 時間帯別アクセス統計
- [ ] リファラー統計
- [ ] グラフ表示機能

### 8. ドキュメント整備
- [ ] API仕様書の作成
- [ ] 設置ガイドの充実
- [ ] サンプルコードの追加

### 9. テストの追加
- [ ] ユニットテスト
- [ ] E2Eテスト
- [ ] 負荷テスト

## 📝 メモ

### 設計方針
- ユーザー登録不要でシンプルに保つ
- URLごとに自動的にカウンター作成
- 管理者のみリセット・値設定が可能
- すべて無料枠で運用可能な設計

### 技術的な注意点
- Vercel の無料枠制限を考慮
- Edge Runtime での動作を前提
- キャッシュ戦略の最適化が重要